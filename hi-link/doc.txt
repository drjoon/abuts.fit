Hi-Link Bridge Service 정리
===========================

1. 전체 구조
-------------
- C# 브리지 서비스(HiLinkBridgeService)가 Hi-Link DLL(Hi-Link.dll, Hi-Link_Advanced.dll)을 호출한다.
- Node.js / 웹 대시보드는 C# 브리지에 HTTP로만 접근한다.
- 기본 포트: http://0.0.0.0:5005

2. 주요 엔드포인트
-------------------
[조회 전용 (안전)]
- GET /machines
  - 등록된 장비 목록 조회
- GET /machines/{uid}/status
  - 장비 상태, 생산량, 알람 정보를 조회

[제어/위험 (락이 없으면 실제 장비 제어)]
- POST /raw
- POST /machines
- DELETE /machines/{uid}
- POST /machines/{uid}/start
- POST /machines/{uid}/stop
- POST /machines/{uid}/reset
- POST /emergency-stop
- POST /resume-all

3. 안전 락 (BRIDGE_ALLOW_CONTROL)
---------------------------------
Program.cs 상단:

  var allowControl = string.Equals(
      Environment.GetEnvironmentVariable("BRIDGE_ALLOW_CONTROL"),
      "true",
      StringComparison.OrdinalIgnoreCase
  );

- 환경변수 BRIDGE_ALLOW_CONTROL == "true" 인 경우에만 제어 API 동작.
- 그 외(미설정, 다른 값)에는 allowControl = false 이고,
  위 제어 엔드포인트들은 전부 403 Forbidden 과
  "control endpoints are disabled" 메시지만 반환한다.
- 운영 장비 PC에서는 환경변수를 설정하지 말고,
  조회용 엔드포인트만 사용한다.

4. C# 브리지 실행 (Windows)
---------------------------
빌드 후 DLL 위치 예시:
- C:\abuts.fit\hi-link\bridge-service\HiLinkBridgeService\bin\Debug\net8.0

실행 명령:

  cd C:\abuts.fit\hi-link\bridge-service\HiLinkBridgeService\bin\Debug\net8.0
  dotnet HiLinkBridgeService.dll

동일 폴더에 다음 파일들이 있어야 한다.
- HiLinkBridgeService.dll
- Hi-Link.dll
- Hi-Link_Advanced.dll
- websocket-sharp.dll

정상 실행 로그 예시:
- Now listening on: http://0.0.0.0:5005
- Application started. Press Ctrl+C to shut down.

5. 자동 실행 스크립트 (start-bridge.bat)
----------------------------------------
운영 PC에서는 pm2 대신, Windows 시작프로그램 + 배치 파일로 자동 실행한다.

배치 파일 예시(start-bridge.bat):

  @echo off
  REM === Hi-Link Bridge Auto Start Script ===

  REM 1. C# 브리지 서비스 실행
  cd /d "C:\abuts.fit\hi-link\bridge-service\HiLinkBridgeService\bin\Debug\net8.0"
  start "HiLinkBridgeService" cmd /c "dotnet HiLinkBridgeService.dll"

  REM 2. Node 브리지 서버 실행
  cd /d "C:\abuts.fit\hi-link\bridge-node"
  start "hi-link-bridge-node" cmd /c "npm run start"

사용 방법:
- 위 내용을 start-bridge.bat 으로 저장 (예: C:\abuts.fit\hi-link\start-bridge.bat).
- Win+R → `shell:startup` 입력 → 시작프로그램 폴더 열기.
- start-bridge.bat 의 **바로가기(Shortcut)** 를 시작프로그램 폴더에 넣는다.
- 이후 PC 로그인 시마다 C# 브리지와 Node 브리지가 자동으로 실행된다.

6. 운영 시 원칙
----------------
- 운영 PC에서는 BRIDGE_ALLOW_CONTROL 환경변수 미설정 상태 유지.
- 테스트 장비에서만 필요 시 BRIDGE_ALLOW_CONTROL=true 로 설정 후 제어 기능 사용.
- 조회용 API(/machines, /machines/{uid}/status)만 쓰는 경우 장비에 제어 명령은 나가지 않는다.