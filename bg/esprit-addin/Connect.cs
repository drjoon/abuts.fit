//--------------------------------------------------------------------------|
// This file was initially generated by the EspritAddInProjectWizard.       |
// Portions Copyright © 2011-2020 DP Technology Corp.                       |
//                                                                          |
// You have a royalty-free right to use, modify, reproduce and distribute   |
// this file (and/or any modified or compiled version of it) in any way     |
// you see fit, provided that you agree that DP Technology has no warranty  |
// obligations or liability whatsoever for this file or for the results of  |
// your use of it or any modified or compiled version of it you may make.   |
//--------------------------------------------------------------------------'

using DPTechnology.AnnexLibraries;
using DPTechnology.AnnexLibraries.EspritAnnex;
using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Threading;
using System.Windows.Forms;
using Esprit;
using Acrodent.EspritAddIns.ESPRIT2025AddinProject.DentalAddinCompat;
using DrawingPoint = System.Drawing.Point;


namespace Acrodent.EspritAddIns.ESPRIT2025AddinProject
{

    [ClassInterface(ClassInterfaceType.None), ComVisible(true),
        Guid("1c4198bd-2143-470a-a041-93f2ebf4c904"),
        ProgId("ESPRIT2025AddinProject.Connect")]
    public class Connect : DPTechnology.AnnexLibraries.EspritAddIn
    {

        // Default Property Procedures should not need changes
        #region " Default Property Procedures "

        private DPTechnology.AnnexLibraries.IConnectionManager _ConnectionManager;
        protected override DPTechnology.AnnexLibraries.IConnectionManager ConnectionManager
        {
            get
            {
                if (_ConnectionManager == null)
                {
                    _ConnectionManager = new DPTechnology.AnnexLibraries.EspritAnnex.ConnectionManager();
                    _ConnectionManager.AddInConnect += _ConnectionManager_AddInConnect;
                    _ConnectionManager.AddInDisconnect += _ConnectionManager_AddInDisconnect;
                    _ConnectionManager.DocumentClosed += _ConnectionManager_DocumentClosed;
                    _ConnectionManager.DocumentInitialize += _ConnectionManager_DocumentInitialize;
                    _ConnectionManager.EspritApplicationShutdown += _ConnectionManager_EspritApplicationShutdown;
                }
                return _ConnectionManager;
            }
        }

        private sealed class AddInRunningForm : Form
        {
            private readonly Label _label;

            public AddInRunningForm(string message)
            {
                FormBorderStyle = FormBorderStyle.FixedToolWindow;
                StartPosition = FormStartPosition.Manual;
                TopMost = true;
                ShowInTaskbar = false;
                Text = "Acrodent Dental Add-in";
                Size = new Size(320, 96);

                _label = new Label
                {
                    Dock = DockStyle.Fill,
                    TextAlign = ContentAlignment.MiddleLeft,
                    Font = new Font("Segoe UI", 10, FontStyle.Bold),
                    Padding = new Padding(16),
                    Text = message
                };

                Controls.Add(_label);

                var screen = Screen.PrimaryScreen?.WorkingArea ?? new Rectangle(0, 0, 800, 600);
                Location = new DrawingPoint(screen.Right - Width - 20, screen.Bottom - Height - 160);
            }

            public void UpdateMessage(string message)
            {
                _label.Text = message;
            }
        }

        private void ShowRunningIndicator()
        {
            try
            {
                var message = "[Acrodent Dental Add-in] 실행 중";

                if (_runningForm == null || _runningForm.IsDisposed)
                {
                    _runningForm = new AddInRunningForm(message);
                }
                else
                {
                    _runningForm.UpdateMessage(message);
                }

                if (!_runningForm.Visible)
                {
                    _runningForm.Show();
                }

                _runningForm.BringToFront();
            }
            catch
            {
                // ignore
            }
        }

        private void HideRunningIndicator()
        {
            try
            {
                if (_runningForm != null && !_runningForm.IsDisposed)
                {
                    _runningForm.Close();
                    _runningForm.Dispose();
                    _runningForm = null;
                }
            }
            catch
            {
                // ignore
            }
        }

        private sealed class AddInStatusForm : Form
        {
            private readonly Label _statusLabel;

            public AddInStatusForm()
            {
                FormBorderStyle = FormBorderStyle.FixedToolWindow;
                StartPosition = FormStartPosition.Manual;
                TopMost = true;
                ShowInTaskbar = false;
                Text = "Acrodent Dental Add-in";
                Size = new Size(360, 120);

                _statusLabel = new Label
                {
                    Dock = DockStyle.Fill,
                    TextAlign = ContentAlignment.MiddleLeft,
                    Font = new Font("Segoe UI", 10, FontStyle.Bold),
                    Padding = new Padding(16),
                };

                Controls.Add(_statusLabel);

                var screen = Screen.PrimaryScreen?.WorkingArea ?? new Rectangle(0, 0, 800, 600);
                Location = new DrawingPoint(screen.Right - Width - 20, screen.Bottom - Height - 20);
            }

            public void UpdateStatus(string message)
            {
                _statusLabel.Text = message;
            }
        }

        private void ShowStatusPanel(string message)
        {
            try
            {
                if (_statusForm == null || _statusForm.IsDisposed)
                {
                    _statusForm = new AddInStatusForm();
                }

                _statusForm.UpdateStatus(message);
                if (!_statusForm.Visible)
                {
                    _statusForm.Show();
                }

                _statusForm.BringToFront();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: ShowStatusPanel failed - {ex.Message}");
            }
        }

        private void HideStatusPanel()
        {
            try
            {
                if (_statusForm != null && !_statusForm.IsDisposed)
                {
                    _statusForm.Close();
                    _statusForm.Dispose();
                    _statusForm = null;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: HideStatusPanel failed - {ex.Message}");
            }
        }

        private static EspritMenus.Menu FindToolbarsSubMenu(EspritMenus.Menus rootMenus)
        {
            if (rootMenus == null)
            {
                return null;
            }

            EspritMenus.Menu viewMenu = FindTopMenu(rootMenus, new string[4] { "&View", "보기(&V)", "视图(&V)", "ビュー(&V)" });
            if (viewMenu == null)
            {
                return null;
            }

            int count = viewMenu.Count;
            for (int i = 1; i <= count; i++)
            {
                EspritMenus.MenuItem item = viewMenu[i];
                if (item == null)
                {
                    continue;
                }

                string name = item.Name;
                if (name == "&工具栏..." || name == "&Toolbars..." || name == "툴바(&T)" || name == "ツールバー(&T)...")
                {
                    return item.SubMenu;
                }
            }

            return null;
        }

        private static EspritMenus.Menu FindTopMenu(EspritMenus.Menus rootMenus, string[] candidates)
        {
            if (rootMenus == null || candidates == null)
            {
                return null;
            }

            foreach (string candidate in candidates)
            {
                if (string.IsNullOrEmpty(candidate))
                {
                    continue;
                }

                try
                {
                    EspritMenus.Menu menu = rootMenus[candidate];
                    if (menu != null)
                    {
                        return menu;
                    }
                }
                catch
                {
                    // ignore
                }
            }

            // fallback: some installs only support ordinal indices
            try
            {
                for (int i = 1; i <= rootMenus.Count; i++)
                {
                    EspritMenus.Menu menu = rootMenus[i];
                    if (menu == null)
                    {
                        continue;
                    }

                    foreach (string candidate in candidates)
                    {
                        if (!string.IsNullOrEmpty(candidate) && menu.Name == candidate)
                        {
                            return menu;
                        }
                    }
                }
            }
            catch
            {
                // ignore
            }

            return null;
        }

        private static void SafeRemoveMenuItem(EspritMenus.Menu menu, string name)
        {
            if (menu == null || string.IsNullOrEmpty(name))
            {
                return;
            }

            try
            {
                menu.Remove(name);
            }
            catch
            {
                // ignore
            }
        }

        private static void EnsureMenuSeparator(EspritMenus.Menu menu)
        {
            if (menu == null)
            {
                return;
            }

            try
            {
                if (menu.Count > 0 && menu[menu.Count].Type != EspritConstants.espMenuItemType.espMenuItemSeparator)
                {
                    menu.Add(EspritConstants.espMenuItemType.espMenuItemSeparator);
                }
            }
            catch
            {
                // ignore
            }
        }

        private static void RemoveTrailingSeparators(EspritMenus.Menu menu)
        {
            if (menu == null)
            {
                return;
            }

            try
            {
                while (menu.Count > 0 && menu[menu.Count].Type == EspritConstants.espMenuItemType.espMenuItemSeparator)
                {
                    menu.Remove(menu.Count);
                }
            }
            catch
            {
                // ignore
            }
        }

        public override string Description
        {
            // To modify the AddInDescription go to the Resources tab in the project Properties.
            get { return Properties.Resources.AddInDescription; }
        }

        public override string FriendlyName
        {
            // To modify the AddInFriendlyName go to the Resources tab in the project Properties.
            get { return Properties.Resources.AddInFriendlyName; }
        }

        public override string Name
        {
            get { return System.Reflection.Assembly.GetExecutingAssembly().GetName().Name; }
        }

        public override System.Diagnostics.TraceLevel OutputWindowTraceLevel
        {
            // To modify the OutputWindowTraceLevel go to the Settings tab in the project Properties.
            get { return Properties.Settings.Default.OutputWindowTraceLevel; }
        }

        protected override Nullable<Int32> PreviousLanguage
        {
            get
            {
                Int32 returnValue;
                if (Int32.TryParse(Properties.Settings.Default.PreviousLanguage, out returnValue))
                    { return returnValue; }
                else
                    { return null; }
            }
            set
            {
                if (value.HasValue)
                {
                    Properties.Settings.Default.PreviousLanguage = value.Value.ToString();
                    Properties.Settings.Default.Save();
                }
            }
        }

        protected override System.Globalization.CultureInfo ResourcesCulture
        {
            get { return Properties.Resources.Culture; }
            set { Properties.Resources.Culture = value; }
        }

        #endregion

        private const string regSettings = "Settings:";
        private const string regPositionDock = "Dock";
        private const string regPositionTop = "Top";
        private const string regPositionLeft = "Left";
        private const string regPositionWidth = "Width";
        private const string regPositionHeight = "Height";

        public static Esprit.Application _espApp;
        public Esprit.ToolBar _newToolbar;

        public EspritMenus.Menu _tbMenu = default(EspritMenus.Menu);
        public EspritMenus.MenuItem _tbMenuItem = default(EspritMenus.MenuItem);

        public List<int> _iCNumbs = new List<int>();
        public const string _toolbarName = "Acrodent_addin";

        public static int _iCntOfCommands = 1;
        public Esprit.PMTab exTab;
        public Esprit.ProjectManager _pm;

        public static int _MyCookie;

        internal static DentalAddinHost DentalHost { get; } = new DentalAddinHost();

        private RepeatProcess _repeatProcess;
        private AddInStatusForm _statusForm;
        private AddInRunningForm _runningForm;
        private bool _toolbarPositionLoaded;
        private System.Windows.Forms.Timer _heartbeatTimer;
        private const int HeartbeatIntervalMs = 60 * 1000;

        public void _ConnectionManager_AddInConnect(Esprit.Application espritApplication)
        {
            _espApp = espritApplication;
            _pm = _espApp.ProjectManager;
            DentalHost.Initialize(_espApp);

            // 서버 자동 시작
            if (_repeatProcess == null)
            {
                try
                {
                    _repeatProcess = new RepeatProcess(_espApp);
                    _repeatProcess.Run();
                }
                catch (Exception ex)
                {
                    LogToEspritOutputs($"[Addin] Failed to auto-start RepeatProcess: {ex.Message}");
                }
            }

            // -------------------------
            // 1. Apply commands
            // -------------------------
            var EC = espritApplication.AddIn as EspritCommands.AddIn;
            _MyCookie = EC.GetCookie();

            try
            {
                _espApp.ToolBars.Remove(_toolbarName);
            }
            catch
            {
                // ignore
            }

            _newToolbar = _espApp.ToolBars.Add(_toolbarName);
            var toolbarIcons = EnsureToolbarIcons();
            for (int i = 0; i < _iCntOfCommands; i++)
            {
                _iCNumbs.Add(EC.AddCommand(_MyCookie, i, "Acrodent Command " + i));
            }

            for (int i = 0; i < _iCntOfCommands; i++)
            {
                Esprit.ToolBarControl tbcon = _newToolbar.Add(EspritConstants.espToolBarControl.espToolBarControlButton, "acrodent_Addin_" + i.ToString(), _iCNumbs[i]);
                tbcon.SetBitmap(toolbarIcons.smallIconPath, toolbarIcons.largeIconPath);
                tbcon.Enabled = true;
                tbcon.Name = "Acrodent command " + i.ToString();
            }

            //EC.OnCommand;
            EC.OnCommand += EC_OnCommand;

            // -------------------------
            // 2. Commands on View menu
            // -------------------------

            try
            {
                EspritMenus.Menus myMenu = _espApp.Menus as EspritMenus.Menus;
                EspritMenus.Menu toolbarsSubMenu = FindToolbarsSubMenu(myMenu);
                if (toolbarsSubMenu != null)
                {
                    SafeRemoveMenuItem(toolbarsSubMenu, _toolbarName);
                    EnsureMenuSeparator(toolbarsSubMenu);
                    _tbMenuItem = toolbarsSubMenu.Add(EspritConstants.espMenuItemType.espMenuItemCommand, _toolbarName, _iCNumbs[0]);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine("Connect: View/Toolbars menu hook failed: " + ex);
            }

            // -------------------------
            // 3. Commands on Tool sub menu
            // -------------------------

            try
            {
                EspritMenus.Menus myMenu = _espApp.Menus as EspritMenus.Menus;
                EspritMenus.Menu toolsMenu = FindTopMenu(myMenu, new string[3] { "&Tools", "도구(&T)", "工具(&T)" });
                if (toolsMenu != null)
                {
                    SafeRemoveMenuItem(toolsMenu, _toolbarName);
                    RemoveTrailingSeparators(toolsMenu);
                    toolsMenu.Add(EspritConstants.espMenuItemType.espMenuItemSeparator);
                    toolsMenu.Add(EspritConstants.espMenuItemType.espMenuItemPopUp, _toolbarName);

                    EspritMenus.Menu popupSubMenu = null;
                    try
                    {
                        popupSubMenu = toolsMenu[_toolbarName].SubMenu;
                    }
                    catch
                    {
                        popupSubMenu = null;
                    }

                    if (popupSubMenu != null)
                    {
                        popupSubMenu.Add(EspritConstants.espMenuItemType.espMenuItemCommand, "Command 1", _iCNumbs[0]);
                    }
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine("Connect: Tools menu hook failed: " + ex);
            }

            // Ensure toolbar position is applied after toolbar/menu creation.
            // This makes sure position loading occurs after the application has initialized UI elements.
            try
            {
                if (!_toolbarPositionLoaded && _newToolbar != null)
                {
                    Toolbar_PositionLoad(_toolbarName, _newToolbar);
                    _toolbarPositionLoaded = true;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: Failed to load toolbar position in AddInConnect: {ex}");
            }

            ShowAddInLoadedIndicator();
            StartHeartbeat();
        }


        private void EC_OnCommand(int Cookie, int UserId)
        {
            if (Cookie != _MyCookie)
                return;

            switch (UserId)
            {
                case 0:
                    // DentalAddin 옵션 패널을 먼저 노출해 사용자가 설정 파일을 확인/수정할 수 있게 한다.
                    DentalHost.ShowPanel();

                    if (_repeatProcess == null)
                    {
                        _repeatProcess = new RepeatProcess(_espApp);
                        _repeatProcess.Run();
                    }

                    break;
            }
        }

        public void _ConnectionManager_AddInDisconnect()
        {
            // Triggered when the Add-In disconnects because it was Unloaded from the Add-In Manager.
            // This means ESPRIT will remain running; otherwise only EspritApplicationShutdown is triggered.
            // This event procedure can be removed if it does not need to be used.
            if (exTab != null)
            {
                try
                {
                    _pm?.PMTabs?.Remove(exTab.HWND);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Trace.WriteLine($"Connect: PMTab remove failed - {ex.Message}");
                }
                exTab = null;
            }

            if (_repeatProcess != null)
            {
                _repeatProcess.Dispose();
                _repeatProcess = null;
            }

            HideStatusPanel();
            HideRunningIndicator();
            StopHeartbeat();
        }

        public void _ConnectionManager_DocumentClosed(bool espritIsShuttingDown)
        {
            // Triggered after the Document has been closed.
            // The Boolean argument signals whether or not the Document was closed because ESPRIT is shutting down.
            // This event procedure can be removed if it does not need to be used.
        }

        public void _ConnectionManager_DocumentInitialize(Esprit.Document espritDocument, string fileName)
        {
            // Triggered whenever the Document object has been re-initialized.
            //
            // If an Esprit.Document object property or variable is declared in your project you can assign it from here.
            // Procedures that apply to both New and existing ESPRIT files can then be called here also.
            //
            // Note that a Null filename (Nothing) indicates a New Document (AfterNewDocumentOpen event),
            // while a non-null filename could be an existing file (AfterDocumentOpen or AfterTemplateOpen event),
            // or could indicate connection to a running Esprit.Application that had a Document already open.
            // In the latter case the filename will not be null, but could be Empty to indicate an unsaved Document.
            //
            if (fileName == null) { return; }
            // Procedures that apply only when opening existing files (and not staring New ones) can be called here.
            //
            // This event procedure can be removed if it does not need to be used (but that is rarely the case).

            // Call toolbar position load only if it has not already been applied.
            if (!_toolbarPositionLoaded && _newToolbar != null)
            {
                try
                {
                    Toolbar_PositionLoad(_toolbarName, _newToolbar);
                    _toolbarPositionLoaded = true;
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Trace.WriteLine($"Connect: Failed to load toolbar position in DocumentInitialize: {ex}");
                }
            }
        }

        public void _ConnectionManager_EspritApplicationShutdown()
        {
            // Triggered when the Add-In disconnects explicitly because ESPRIT is shutting down.
            // This event can be removed if it does not need to be used.
            Toolbar_PositionSave(_toolbarName, _newToolbar);
            
            if (_repeatProcess != null)
            {
                _repeatProcess.Dispose();
                _repeatProcess = null;
            }

            HideRunningIndicator();
            StopHeartbeat();
        }

        #region TOOLBAR_POSITION
        private void Toolbar_PositionSave(string aToolbarName, Esprit.ToolBar aToolbarObject)
        {
            if (aToolbarObject == null) return;
            WriteReg(regPositionDock, aToolbarObject.Position.ToString());
            WriteReg(regPositionTop, aToolbarObject.Top.ToString());
            WriteReg(regPositionLeft, aToolbarObject.Left.ToString());
            WriteReg(regPositionWidth, aToolbarObject.Width.ToString());
            WriteReg(regPositionHeight, aToolbarObject.Height.ToString());
        }

        private void Toolbar_PositionLoad(string aToolbarName, Esprit.ToolBar aToolbarObject)
        {

            string pos = ReadReg(regPositionDock);
            switch (pos)
            {
                case "espToolBarPositionFloating":
                    {
                        //aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionFloating);
                        break;
                    }
                case "espToolBarPositionTop":
                    {
                        aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionTop);
                        break;
                    }
                case "espToolBarPositionLeft":
                    {
                        aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionLeft);
                        break;
                    }
                case "espToolBarPositionBottom":
                    {
                        aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionBottom);
                        break;
                    }
                case "espToolBarPositionRight":
                    {
                        aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionRight);
                        break;
                    }
            }
            //aToolbarObject.Dock(EspritConstants.espToolBarPosition.espToolBarPositionFloating);
            switch (aToolbarObject.Position)
            {
                case EspritConstants.espToolBarPosition.espToolBarPositionBottom:
                    {
                        aToolbarObject.Top = Convert.ToInt32(ReadReg(regPositionTop)) + aToolbarObject.Height;
                        aToolbarObject.Left = Convert.ToInt32(ReadReg(regPositionLeft));
                        break;
                    }
                case EspritConstants.espToolBarPosition.espToolBarPositionLeft:
                    {
                        aToolbarObject.Top = Convert.ToInt32(ReadReg(regPositionTop));
                        aToolbarObject.Left = Convert.ToInt32(ReadReg(regPositionLeft)) + aToolbarObject.Width;
                        break;
                    }
                case EspritConstants.espToolBarPosition.espToolBarPositionRight:
                    {
                        aToolbarObject.Top = Convert.ToInt32(ReadReg(regPositionTop));
                        aToolbarObject.Left = Convert.ToInt32(ReadReg(regPositionLeft));
                        break;
                    }
                case EspritConstants.espToolBarPosition.espToolBarPositionTop:
                    {
                        aToolbarObject.Top = Convert.ToInt32(ReadReg(regPositionTop));
                        aToolbarObject.Left = Convert.ToInt32(ReadReg(regPositionLeft));
                        break;
                    }
            }
        }
        #endregion TOOLBAR_POSITION

        #region Registry_Read_Write
        private string ReadReg(string valueName)
        {
            const string userRoot = "HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\D.P.Technology\\ESPRIT\\AddIns";
            const string subkey = "ESPRIT2025AddinProject.Connect\\" + regSettings + _toolbarName + ".ToolBar";
            const string keyName = userRoot + "\\" + subkey;
            var val = Registry.GetValue(keyName, valueName, "");
            if(val == null)
                return "";
            string tStr = Registry.GetValue(keyName, valueName, "").ToString();
            return tStr;
        }

        void WriteReg(string valueName, string POSvalue)
        {
            const string userRoot = "HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\D.P.Technology\\ESPRIT\\AddIns";
            const string subkey = "ESPRIT2025AddinProject.Connect\\" + regSettings + _toolbarName + ".ToolBar";
            const string keyName = userRoot + "\\" + subkey;
            Registry.SetValue(keyName, valueName, POSvalue, RegistryValueKind.String);
        }
        #endregion Registry_Read_Write

        private static (string smallIconPath, string largeIconPath) EnsureToolbarIcons()
        {
            string assemblyLocation = Assembly.GetExecutingAssembly().Location;
            string baseDir = Path.GetDirectoryName(assemblyLocation) ?? AppDomain.CurrentDomain.BaseDirectory;
            string iconDir = Path.Combine(baseDir, "Icons");
            Directory.CreateDirectory(iconDir);

            string smallIcon = Path.Combine(iconDir, "tooth_16.bmp");
            string largeIcon = Path.Combine(iconDir, "tooth_32.bmp");

            if (!File.Exists(smallIcon))
            {
                GenerateToolbarIcon(smallIcon, 16);
            }

            if (!File.Exists(largeIcon))
            {
                GenerateToolbarIcon(largeIcon, 32);
            }

            return (smallIcon, largeIcon);
        }

        private static void GenerateToolbarIcon(string path, int size)
        {
            using (var bmp = new Bitmap(size, size))
            using (var g = Graphics.FromImage(bmp))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                var bgColor = Color.FromArgb(32, 70, 255);
                var accentColor = Color.White;
                g.Clear(bgColor);

                using (var brush = new SolidBrush(accentColor))
                {
                    var toothRect = new Rectangle((int)(size * 0.25), (int)(size * 0.15), (int)(size * 0.5), (int)(size * 0.55));
                    g.FillEllipse(brush, toothRect);

                    var rootRect = new Rectangle((int)(size * 0.35), (int)(size * 0.55), (int)(size * 0.3), (int)(size * 0.35));
                    g.FillPolygon(brush, new DrawingPoint[]
                    {
                        new DrawingPoint(rootRect.Left, rootRect.Top),
                        new DrawingPoint(rootRect.Right, rootRect.Top),
                        new DrawingPoint(rootRect.Right - (int)(size * 0.08), rootRect.Bottom),
                        new DrawingPoint(rootRect.Left + (int)(size * 0.08), rootRect.Bottom)
                    });
                }

                bmp.Save(path, ImageFormat.Bmp);
            }
        }

        private void ShowAddInLoadedIndicator()
        {
            string banner = $"[Acrodent Dental Add-in] {DateTime.Now:yyyy-MM-dd HH:mm:ss}에 로드되었습니다.";
            LogToEspritOutputs(banner);
            ShowToast(banner);
        }

        private void StartHeartbeat()
        {
            StopHeartbeat();
            _heartbeatTimer = new System.Windows.Forms.Timer();
            _heartbeatTimer.Interval = HeartbeatIntervalMs;
            _heartbeatTimer.Tick += HeartbeatTimerOnTick;
            _heartbeatTimer.Start();
        }

        private void StopHeartbeat()
        {
            if (_heartbeatTimer != null)
            {
                _heartbeatTimer.Tick -= HeartbeatTimerOnTick;
                _heartbeatTimer.Stop();
                _heartbeatTimer.Dispose();
                _heartbeatTimer = null;
            }
        }

        private void HeartbeatTimerOnTick(object sender, EventArgs e)
        {
            var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var heartbeatMessage = $"[{timestamp}] My Dental Addin";
            LogToEspritOutputs(heartbeatMessage);
            ShowStatusPanel(heartbeatMessage);
        }

        private void LogToEspritOutputs(string message)
        {
            if (_espApp == null)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: cannot log message (app null) - {message}");
                return;
            }

            var logged = false;

            try
            {
                _espApp.OutputWindow?.Text(message);
                logged = true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: OutputWindow.Text failed - {ex.Message}");
            }

            if (!logged)
            {
                System.Diagnostics.Trace.WriteLine($"Connect: {message}");
            }
        }

        private void ShowToast(string message)
        {
            try
            {
                ThreadPool.QueueUserWorkItem(_ =>
                {
                    using (var toast = new AddInToastForm(message))
                    {
                        toast.Show();
                        System.Windows.Forms.Application.DoEvents();
                        Thread.Sleep(2500);
                        toast.Invoke(new Action(() => toast.Close()));
                    }
                });
            }
            catch
            {
                // ignore
            }
        }

        private sealed class AddInToastForm : Form
        {
            public AddInToastForm(string message)
            {
                FormBorderStyle = FormBorderStyle.None;
                StartPosition = FormStartPosition.Manual;
                ShowInTaskbar = false;
                TopMost = true;
                BackColor = Color.FromArgb(32, 70, 255);
                ForeColor = Color.White;
                Padding = new Padding(24, 18, 24, 18);

                var textLabel = new Label
                {
                    AutoSize = true,
                    Text = message,
                    Font = new Font("Segoe UI", 10, FontStyle.Bold),
                    ForeColor = Color.White,
                    BackColor = Color.Transparent
                };

                    Controls.Add(textLabel);
                    AutoSize = true;

                    var screen = Screen.PrimaryScreen?.WorkingArea ?? new Rectangle(0, 0, 800, 600);
                    Location = new DrawingPoint(
                        screen.Right - Width - 20,
                        screen.Bottom - Height - 20);
            }
        }
    }

}
