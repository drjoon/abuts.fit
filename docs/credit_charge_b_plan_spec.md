# 크레딧 충전 - B안(입금확인형) 정책 스펙 (확정)

## 1. 목적

- 결제위젯/PG 승인 플로우 없이, **회사 계좌 입금 내역**을 기준으로 크레딧 충전을 처리한다.
- 자동 매칭은 **오탐(잘못된 적립)**을 최우선으로 방지한다.

## 2. 용어

- **조직(기공소)**: RequestorOrganization
- **고정 코드**: 조직별로 부여되는 **5자리 숫자** 코드(매번 동일)
- **ChargeOrder**: 사용자가 생성하는 충전 요청(선생성)
- **BankTransaction**: 회사 계좌 거래내역 조회로 수집한 입금 건
- **CreditLedger**: 크레딧 변동 원장(적립/차감/환불 등)

## 3. 자동 매칭 핵심 정책 (필수 동시 만족)

### 3.1 매칭 기준

- **코드 기준**
  - **5자리 고정 코드**
  - 코드 첫 자리는 **1 이상** (예: `10001`, `10002`, ...)
  - 코드: **조직(기공소)별 1개 부여**, 매번 동일 코드 사용
- **금액 기준 (선택지 A 확정)**
  - 사용자가 실제 입금하는 금액 = **VAT 포함 결제금액** `ChargeOrder.amountTotal`
  - 거래내역의 입금액 `tranAmt` 와 **`ChargeOrder.amountTotal`을 비교**
- **자동 승인 조건**
  - `코드(5자리) + 입금금액(tranAmt)` 이 **동시에 일치**할 때만 자동 승인

### 3.2 ChargeOrder 선생성 + 유효시간(24시간)

- 사용자가 “충전 요청”을 먼저 생성 → `ChargeOrder(PENDING)` 생성
- `ChargeOrder`는 생성 시점부터 **24시간 내 입금만 자동 인정**
- 24시간 경과 시 `ChargeOrder(EXPIRED)` 처리
  - 이후 입금은 **자동매칭 금지**
  - 운영자(관리자) **수동 매칭**으로만 처리

## 4. 폴링(거래내역 수집)

- 회사 계좌 거래내역 조회를 **30분 주기**로 폴링 수행
- KFTC 거래내역조회 API 결과를 `BankTransaction`으로 저장(upsert)
  - 중복 수집/재조회에 대비하여, 입금 건은 **고유키 기준 upsert**를 전제로 한다.

## 5. 데이터/프로세스 플로우

### 5.1 사용자 플로우

1. 사용자가 크레딧 충전을 요청 → `ChargeOrder(PENDING)` 생성
2. 화면에 아래를 안내

- 입금 계좌
- 입금 시 메모/통장표시에 **조직 고정 5자리 코드** 입력
- 입금 금액은 **VAT 포함 `amountTotal`**
- **24시간 내 입금만 자동 반영** (이후는 관리자 수동 처리)

3. 사용자가 이체 실행

### 5.2 서버 폴링/자동 매칭 플로우

1. 30분마다 KFTC 거래내역조회 API로 회사 계좌 입금 내역 수집 → `BankTransaction` 저장(upsert)
2. 각 입금 건에 대해

- `printed_content` 등에서 5자리 코드 추출
- 동일 코드 조직의 `ChargeOrder(PENDING)` 중 아래를 만족하는 주문을 탐색

  - `amountTotal == tranAmt`
  - `expiresAt > now`
  - 아직 미매칭

- 조건을 만족하는 주문이 **유일하게 1개**일 때만 매칭

3. 유일 매칭 성공 시

- `ChargeOrder(MATCHED)` + `BankTransaction(MATCHED)` 처리 및 연결
- `CreditLedger(CHARGE)` 적립 생성

## 6. 자동 매칭 실패 시 처리

- 자동 매칭 실패(코드 추출 실패/금액 불일치/복수 후보/유효시간 만료 등) 시:
  - 운영자(관리자)가 **수동 매칭 UI**로 처리
  - 동일하게 크레딧 적립 + 감사로그 기록

## 7. 관리자 수동 매칭 + 감사로그 요구사항

- 미매칭 입금/미처리 ChargeOrder 리스트에서 **수동 연결**
- 반드시 감사로그 기록(최소 필드)

- **누가**: adminUserId
- **언제**: timestamp
- **무엇을 연결**: bankTransactionId, chargeOrderId
- **근거/사유**: memo/reason

## 8. 토스페이먼츠 레거시 코드 삭제(다음 세션 범위)

### 8.1 목표

- 토스 결제위젯 기반 크레딧 충전 플로우(프론트/백엔드) 제거
- 이후 충전은 **B안(입금확인형)**으로만 진행

### 8.2 다음 세션 작업 방식(안전 절차)

1. 사용처 식별

- 프론트: `CreditPaymentTab` 및 결제 위젯 로딩/결제 요청/성공 콜백 관련 코드
- 백엔드: 토스 결제 승인/검증/웹훅/결제키 저장 등 관련 API/유틸
- 환경변수/시크릿/설정/문서 포함

2. “삭제” 전 확인할 체크

- 운영/배포 환경에서 토스 결제가 실제 사용 중인지
- PG 심사 대응상 “결제 수단 표기”를 어디까지 바꿔야 하는지(/service, 약관 등)

3. 제거

- 토스 관련 라우트/컨트롤러/유틸/프론트 위젯 코드 제거
- 대체로 B안 UI(충전요청 생성 + 입금 안내)로 연결되도록 정리
