<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NC 코드 시뮬레이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 1.5rem;
        height: calc(100vh - 4rem);
        padding: 2rem;
      }
      .panel {
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .panel h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
      }
      #simulator-canvas {
        background-color: #e5e7eb;
        border-radius: 1rem;
        width: 100%;
        height: 100%;
        border: 2px solid #d1d5db;
      }
      #code-display {
        background-color: #1f2937;
        color: #d1d5db;
        font-family: monospace;
        white-space: pre;
        overflow: auto;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 100%;
        line-height: 1.25;
        flex-grow: 1;
      }
      .controls-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }
      .zone-list {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 0.5rem;
      }
      .zone-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
      }
      .zone-item input {
        transform: scale(1.2);
        cursor: pointer;
      }
      .btn {
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
        text-align: center;
      }
      .btn-primary {
        background-color: #3b82f6;
        color: #ffffff;
      }
      .btn-primary:hover {
        background-color: #2563eb;
      }
      .btn-secondary {
        background-color: #e5e7eb;
        color: #4b5563;
      }
      .btn-secondary:hover {
        background-color: #d1d5db;
      }
      .range-slider {
        width: 100%;
        -webkit-appearance: none;
        height: 8px;
        background: #d1d5db;
        border-radius: 5px;
        outline: none;
        transition: opacity 0.2s;
      }
      .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #3b82f6;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #ffffff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel flex flex-col">
        <h2>파일 업로드</h2>
        <label for="nc-file-input" class="btn btn-primary cursor-pointer mb-4">
          NC 파일 선택
          <input
            type="file"
            id="nc-file-input"
            class="hidden"
            accept=".nc,.txt"
          />
        </label>

        <h2>시뮬레이션 컨트롤</h2>
        <div class="controls-grid">
          <button id="play-btn" class="btn btn-primary">재생</button>
          <button id="pause-btn" class="btn btn-secondary">일시정지</button>
          <button id="stop-btn" class="btn btn-secondary">정지</button>
        </div>

        <div class="flex items-center gap-2 mt-2">
          <label for="speed-slider" class="font-semibold">속도:</label>
          <input
            type="range"
            id="speed-slider"
            class="range-slider"
            min="1"
            max="100"
            value="20"
          />
        </div>

        <h2 class="mt-4">가공 구역 (Zone)</h2>
        <div id="zone-controls" class="zone-list">
          <!-- Zones will be populated here by JavaScript -->
        </div>
      </div>

      <div class="panel flex items-center justify-center">
        <canvas id="simulator-canvas"></canvas>
      </div>

      <div class="panel flex flex-col">
        <h2>NC 코드</h2>
        <pre id="code-display" class="flex-grow"></pre>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fileInput = document.getElementById("nc-file-input");
        const codeDisplay = document.getElementById("code-display");
        const canvas = document.getElementById("simulator-canvas");
        const ctx = canvas.getContext("2d");
        const playBtn = document.getElementById("play-btn");
        const pauseBtn = document.getElementById("pause-btn");
        const stopBtn = document.getElementById("stop-btn");
        const speedSlider = document.getElementById("speed-slider");
        const zoneControls = document.getElementById("zone-controls");

        let parsedData = null;
        let currentStep = 0;
        let animationId = null;
        let isPaused = false;
        let zones = {};

        const stock = { diameter: 12, length: 40 };
        let currentPos = { x: 0, z: 0 };
        let minX = 0,
          maxX = 0,
          minZ = 0,
          maxZ = 0;

        // Drawing parameters
        const scale = 10; // Scale factor for visualization
        let offsetX = 0;
        let offsetY = 0;

        // NC 코드 데이터 (오류 해결을 위해 변수에 직접 저장)
        const initialNcCode = `%\n(================================================)
(    개선된 더미 테스트 파트 - 실무 기반      )
(    쓰가미 B0-125 / 한화 XD-10                 )
(    Material: Ti6Al4V 티타늄 (실제 어벗먼트용)  )
(    Stock: ⌀12 x 40L mm                       )
(================================================)

(--- 개선된 테스트 파트 설계 사양 ---)
(
Zone 1: ⌀10.0 x 8L     - T01 황삭 전용 (CNMG 120408)
Zone 2: ⌀9.8 x 8L      - T02 정삭 전용 (CNMG 090304) 
Zone 3: ⌀7.0 x 10L     - 단차부 (정삭툴 연장)
Zone 4: 내경 ⌀6.0 x 8deep - T03 보링바 전용 (CCMT 09T304)
Zone 5: 언더컷 홈 3mm폭  - T04 홈파기 전용 (QCG 315)
Zone 6: 센터링 #2        - T11 센터드릴 전용
Zone 7: 드릴 ⌀2.0       - T12 HSS-CO 드릴 전용
Zone 8: 키웨이 1.0x5L    - T13 1mm 엔드밀 전용
Zone 9: 마이크로홈 0.5폭  - T14 0.5mm 엔드밀 전용
Zone 10: M2.5 나사       - T15 탭 전용
)
(================================================)
(--- T01 황삭 공정 ---)
G00 G40 G80 G90 G99 T0101
G50 S1500
G96 S100 M03
G00 X14.0 Z2.0
G01 Z0.0 F0.5
G01 X10.0 Z0.0
Z-8.0
X12.0
G00 Z2.0
(ZONE 1 END)

(--- T02 정삭 공정 ---)
G00 T0202
G50 S2000
G96 S120 M03
G00 X14.0 Z2.0
G01 X9.8 Z0.0 F0.2
Z-8.0
(ZONE 2 END)

(--- T03 보링 공정 ---)
G00 T0303
G50 S3000
G96 S150 M03
G00 X6.0 Z-8.0
Z-16.0
G01 X6.0 Z-16.0 F0.1
G00 Z2.0
(ZONE 3 END)

(--- T04 홈파기 공정 ---)
G00 T0404
G50 S1000
G97 S800 M03
G00 X10.0 Z-18.0
G01 X6.0 Z-18.0 F0.05
Z-19.2
(ZONE 4 END)

(--- T11 센터드릴 공정 ---)
G00 T1111
G97 S1200 M03
G00 X0.0 Z2.0
G01 Z-2.0 F0.08
G00 Z2.0
(ZONE 5 END)

(--- T12 드릴 공정 ---)
G00 T1212
G97 S1000 M03
G00 X0.0 Z2.0
G01 Z-7.0 F0.1
G00 Z2.0
(ZONE 6 END)
M30`;

        // Handle file upload
        fileInput.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const ncCode = e.target.result;
            codeDisplay.textContent = ncCode;
            parseNC(ncCode);
            render();
            updateZoneControls();
            resetSimulation();
          };
          reader.readAsText(file);
        });

        // Parse the NC code
        function parseNC(code) {
          const lines = code.split("\n");
          const data = [];
          let currentZone = null;
          let lastPos = { X: 0, Z: 0 };
          let lastG = "G00";

          // Reset global position and bounds
          minX = stock.diameter / 2;
          maxX = -stock.diameter / 2;
          minZ = 0;
          maxZ = -stock.length;

          lines.forEach((line, index) => {
            // Extract zone from comments
            const zoneMatch = line.match(/\(ZONE\s*(\d+).*?\)/i);
            if (zoneMatch) {
              currentZone = `Zone ${zoneMatch[1]}`;
              if (!zones[currentZone]) {
                zones[currentZone] = true;
              }
            }

            const gCodeMatch = line.match(
              /(G\d{2,3})|G\d+\s*X([^Z\s]+)?\s*Z([^X\s]+)?/i
            );
            if (gCodeMatch) {
              const gCode = gCodeMatch[1] || lastG;
              lastG = gCode;

              const xMatch = line.match(/X\s*([-\d.]+)/i);
              const zMatch = line.match(/Z\s*([-\d.]+)/i);

              const currentX = xMatch ? parseFloat(xMatch[1]) : lastPos.X;
              const currentZ = zMatch ? parseFloat(zMatch[1]) : lastPos.Z;

              if (gCode === "G00" || gCode === "G01") {
                data.push({
                  type: "linear",
                  gCode,
                  from: { X: lastPos.X, Z: lastPos.Z },
                  to: { X: currentX, Z: currentZ },
                  zone: currentZone,
                  line: index + 1,
                });
              }

              // Update last position for the next line
              lastPos.X = currentX;
              lastPos.Z = currentZ;

              // Update bounds
              minX = Math.min(minX, lastPos.X, currentX);
              maxX = Math.max(maxX, lastPos.X, currentX);
              minZ = Math.min(minZ, lastPos.Z, currentZ);
              maxZ = Math.max(maxZ, lastPos.Z, currentZ);
            }
          });
          parsedData = data;
        }

        // Update zone checkboxes
        function updateZoneControls() {
          zoneControls.innerHTML = "";
          const allZones = Object.keys(zones).sort((a, b) => {
            const numA = parseInt(a.replace("Zone ", ""));
            const numB = parseInt(b.replace("Zone ", ""));
            return numA - numB;
          });

          allZones.forEach((zone) => {
            const div = document.createElement("div");
            div.className = "zone-item";
            div.innerHTML = `
                <input type="checkbox" id="${zone
                  .toLowerCase()
                  .replace(" ", "-")}" data-zone="${zone}" checked>
                <label for="${zone
                  .toLowerCase()
                  .replace(
                    " ",
                    "-"
                  )}" class="text-sm font-medium text-gray-700">${zone}</label>
            `;
            zoneControls.appendChild(div);
          });

          zoneControls
            .querySelectorAll('input[type="checkbox"]')
            .forEach((checkbox) => {
              checkbox.addEventListener("change", () => {
                const zone = checkbox.dataset.zone;
                zones[zone] = checkbox.checked;
                render();
              });
            });
        }

        // Set canvas dimensions
        function setCanvasDimensions() {
          const panel = canvas.parentElement;
          const width = panel.clientWidth;
          const height = panel.clientHeight;
          const dpr = window.devicePixelRatio || 1;

          canvas.width = width * dpr;
          canvas.height = height * dpr;
          ctx.scale(dpr, dpr);
          canvas.style.width = width + "px";
          canvas.style.height = height + "px";
        }

        // Render the simulation view
        function render() {
          if (!parsedData) return;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Calculate dynamic offset and scale
          const padding = 20;
          const canvasWidth = canvas.clientWidth - 2 * padding;
          const canvasHeight = canvas.clientHeight - 2 * padding;

          const dataRangeX = Math.abs(maxX - minX);
          const dataRangeZ = Math.abs(maxZ - minZ);

          const scaleX = canvasWidth / (dataRangeX * 2);
          const scaleZ = canvasHeight / dataRangeZ;

          const currentScale = Math.min(scaleX, scaleZ, 15);

          offsetX = canvas.clientWidth / 2;
          offsetY = canvas.clientHeight / 2;

          ctx.save();
          ctx.translate(offsetX, offsetY);
          ctx.scale(currentScale, currentScale);

          // Invert X-axis for better visual representation
          ctx.scale(-1, 1);

          // Draw stock
          ctx.beginPath();
          ctx.rect(-stock.diameter / 2, minZ, stock.diameter, -minZ + maxZ);
          ctx.fillStyle = "#9ca3af";
          ctx.fill();
          ctx.stroke();

          // Draw tool paths
          parsedData.forEach((item, index) => {
            if (!zones[item.zone]) return;

            const startX = item.from.X;
            const startZ = item.from.Z;
            const endX = item.to.X;
            const endZ = item.to.Z;

            ctx.beginPath();
            ctx.moveTo(startX, startZ);
            ctx.lineTo(endX, endZ);

            if (index < currentStep) {
              // Completed path
              ctx.strokeStyle = "#2563eb";
              ctx.lineWidth = 1;
              ctx.stroke();
            } else if (index === currentStep) {
              // Current path
              ctx.strokeStyle = "#ef4444";
              ctx.lineWidth = 2;
              ctx.stroke();
            }
          });

          // Draw tool head
          if (currentStep < parsedData.length) {
            const { to } = parsedData[currentStep];
            const x = to.X;
            const z = to.Z;

            ctx.beginPath();
            ctx.arc(x, z, 1.5, 0, 2 * Math.PI);
            ctx.fillStyle = "#111827";
            ctx.fill();
          }

          ctx.restore();
        }

        // Animation loop
        function animate() {
          if (!parsedData || isPaused) {
            animationId = requestAnimationFrame(animate);
            return;
          }

          if (currentStep < parsedData.length) {
            render();
            const originalLines = codeDisplay.textContent.split("\n");
            codeDisplay.innerHTML = parsedData
              .map((item, index) => {
                const line = originalLines[item.line - 1];
                if (index === currentStep) {
                  return `<span style="background-color: #3b82f6; color: white;">${line}</span>`;
                }
                return line;
              })
              .join("\n");
            const highlightedLine = codeDisplay.querySelector("span");
            if (highlightedLine) {
              codeDisplay.scrollTop =
                highlightedLine.offsetTop - codeDisplay.clientHeight / 2;
            }

            currentStep++;
            const speed = 1000 - parseInt(speedSlider.value);
            animationId = setTimeout(animate, speed);
          } else {
            stopSimulation();
          }
        }

        function resetSimulation() {
          clearTimeout(animationId);
          animationId = null;
          currentStep = 0;
          isPaused = false;
          render();
          playBtn.classList.remove("btn-secondary");
          playBtn.classList.add("btn-primary");
          pauseBtn.classList.add("btn-secondary");
          pauseBtn.classList.remove("btn-primary");
          stopBtn.classList.add("btn-secondary");
          stopBtn.classList.remove("btn-primary");
        }

        function startSimulation() {
          if (animationId) return;
          isPaused = false;
          animate();
          playBtn.classList.add("btn-secondary");
          playBtn.classList.remove("btn-primary");
          pauseBtn.classList.remove("btn-secondary");
          pauseBtn.classList.add("btn-primary");
          stopBtn.classList.remove("btn-secondary");
          stopBtn.classList.add("btn-primary");
        }

        function pauseSimulation() {
          isPaused = !isPaused;
          if (isPaused) {
            pauseBtn.textContent = "계속";
            clearTimeout(animationId);
          } else {
            pauseBtn.textContent = "일시정지";
            startSimulation();
          }
        }

        function stopSimulation() {
          resetSimulation();
          pauseBtn.textContent = "일시정지";
          codeDisplay.textContent = initialNcCode;
        }

        playBtn.addEventListener("click", startSimulation);
        pauseBtn.addEventListener("click", pauseSimulation);
        stopBtn.addEventListener("click", stopSimulation);

        // Initial setup
        window.addEventListener("resize", setCanvasDimensions);
        setCanvasDimensions();

        // Load the dummy file initially
        codeDisplay.textContent = initialNcCode;
        parseNC(initialNcCode);
        updateZoneControls();
        render();
      });
    </script>
  </body>
</html>
